# Amazon Aurora DSQL - ID 列とシーケンスオブジェクトのサポート

**リリース日**: 2026 年 2 月 13 日
**サービス**: Amazon Aurora DSQL
**機能**: Identity Columns and Sequence Objects

📊 [このアップデートのインフォグラフィックを見る](https://takech9203.github.io/20260213-amazon-aurora-dsql-adds-identity-columns-sequence.html)

## 概要

Amazon Aurora DSQL が ID 列 (IDENTITY columns) とシーケンスオブジェクト (SEQUENCE objects) のサポートを追加しました。この機能により、自動インクリメントの整数ベース ID を生成でき、コンパクトで人間が読みやすい識別子 (注文番号、アカウント ID、運用リファレンスなど) の作成が可能になります。

このアップデートは、既存の PostgreSQL アプリケーションからの移行を簡素化します。アプリケーションコードやミドルウェアでカスタム ID 生成ロジックを実装する必要がなくなり、データベースレベルで標準的な PostgreSQL の構文を使用して ID を自動生成できます。

**アップデート前の課題**

- Aurora DSQL で自動インクリメントの整数 ID を生成するネイティブな方法がなかった
- コンパクトで人間が読みやすい ID を生成するために、アプリケーションコードやミドルウェアにカスタムロジックが必要だった
- 既存の PostgreSQL アプリケーションで IDENTITY 列やシーケンスを使用している場合、Aurora DSQL への移行が困難だった

**アップデート後の改善**

- IDENTITY 列とシーケンスオブジェクトにより、自動インクリメント ID をデータベースレベルで生成可能になった
- カスタム ID 生成ロジックが不要になり、アプリケーションの複雑さが軽減された
- 既存の PostgreSQL アプリケーションの移行が容易になった

## サービスアップデートの詳細

### 主要機能

1. **IDENTITY 列のサポート**
   - `GENERATED ALWAYS AS IDENTITY` と `GENERATED BY DEFAULT AS IDENTITY` の両方をサポート
   - テーブル作成時に IDENTITY 列を定義し、自動的に整数値を生成
   - INSERT 時に値を省略するか `DEFAULT` キーワードを使用して自動生成値を取得
   - `ALWAYS` は明示的な値の挿入を制限し、`BY DEFAULT` はユーザー指定値を優先

2. **シーケンスオブジェクト (CREATE SEQUENCE)**
   - PostgreSQL 互換の CREATE SEQUENCE 構文をサポート
   - `nextval`、`currval`、`setval` 関数で操作可能
   - INCREMENT、MINVALUE、MAXVALUE、CYCLE、START WITH などのパラメータを設定可能
   - データ型は BIGINT をサポート

3. **分散環境に最適化された CACHE 設定**
   - CACHE = 1 または CACHE >= 65536 の 2 つのモードを提供
   - CACHE >= 65536 は高並行性ワークロード向けにスループットを最適化
   - CACHE = 1 は厳密な順序性が求められるワークロード向け
   - 分散システムにおけるコーディネーションオーバーヘッドを考慮した設計

## 技術仕様

### IDENTITY 列の構文

| 構文 | 説明 |
|------|------|
| `GENERATED ALWAYS AS IDENTITY` | システム生成値を強制。明示的な値は `OVERRIDING SYSTEM VALUE` が必要 |
| `GENERATED BY DEFAULT AS IDENTITY` | デフォルトでシーケンス値を使用。明示的な値の指定も可能 |

### CACHE 設定ガイド

| CACHE 値 | 適用場面 | 特徴 |
|----------|----------|------|
| CACHE = 1 | 低頻度の ID 割り当て、順序性が重要 | 厳密な順序、ギャップ最小化 |
| CACHE >= 65536 | 高頻度の ID 生成、並行セッション多数 | 高スループット、ギャップ許容 |

### UUID との使い分け

| 識別子タイプ | 推奨ユースケース |
|-------------|-----------------|
| UUID | プライマリキー、スケーラビリティ重視、コーディネーション不要 |
| シーケンス/IDENTITY | 人間が読みやすい ID、レポート、外部インターフェース |

### CREATE SEQUENCE 構文

```sql
CREATE SEQUENCE [ IF NOT EXISTS ] name CACHE cache
    [ AS data_type ]
    [ INCREMENT [ BY ] increment ]
    [ MINVALUE minvalue | NO MINVALUE ]
    [ MAXVALUE maxvalue | NO MAXVALUE ]
    [ [ NO ] CYCLE ]
    [ START [ WITH ] start ]
    [ OWNED BY { table_name.column_name | NONE } ]
```

## 設定方法

### 前提条件

1. Amazon Aurora DSQL クラスターが利用可能なリージョンで稼働している
2. Aurora DSQL への接続権限が設定されている
3. PostgreSQL 互換のクライアントツールが準備されている

### 手順

#### ステップ 1: IDENTITY 列を持つテーブルの作成

```sql
-- 高並行性ワークロード向け (CACHE >= 65536)
CREATE TABLE orders (
    order_id bigint GENERATED ALWAYS AS IDENTITY (CACHE 70000),
    customer_name text,
    order_date timestamp DEFAULT now()
);

-- 順序性重視のワークロード向け (CACHE = 1)
CREATE TABLE accounts (
    account_id bigint GENERATED BY DEFAULT AS IDENTITY (CACHE 1),
    account_name text,
    created_at timestamp DEFAULT now()
);
```

IDENTITY 列を持つテーブルを作成します。CACHE 値はワークロードパターンに応じて選択してください。

#### ステップ 2: シーケンスオブジェクトの作成

```sql
-- 独立したシーケンスを作成
CREATE SEQUENCE ticket_seq CACHE 65536 START 1001;

-- シーケンスを使用した INSERT
INSERT INTO support_tickets (ticket_id, description)
VALUES (nextval('ticket_seq'), 'ネットワーク接続の問題');
```

独立したシーケンスオブジェクトを作成し、nextval 関数で次の値を取得します。

#### ステップ 3: IDENTITY 列を使用したデータ挿入

```sql
-- IDENTITY 列の値を自動生成
INSERT INTO orders (customer_name, order_date)
VALUES ('田中太郎', now());

INSERT INTO orders (customer_name, order_date)
VALUES ('鈴木花子', now());

-- 結果を確認
SELECT * FROM orders;
-- order_id | customer_name | order_date
-- ---------+---------------+---------------------
--        1 | 田中太郎       | 2026-02-13 10:00:00
--        2 | 鈴木花子       | 2026-02-13 10:01:00
```

IDENTITY 列の値は INSERT 時に自動的に生成されます。

## メリット

### ビジネス面

- **移行コストの削減**: 既存の PostgreSQL アプリケーションの移行が簡素化され、コードの変更が最小限に
- **開発効率の向上**: カスタム ID 生成ロジックが不要になり、開発速度が向上
- **可読性の高い ID**: 注文番号やアカウント ID など、人間が読みやすいコンパクトな識別子を生成

### 技術面

- **PostgreSQL 互換性**: 標準的な PostgreSQL 構文をサポートし、既存のスキル・ツールを活用可能
- **分散環境への最適化**: CACHE 設定により、分散システムにおけるパフォーマンスと順序性のトレードオフを制御
- **柔軟な ID 戦略**: UUID と整数ベース ID を組み合わせた識別子戦略を実装可能

## デメリット・制約事項

### 制限事項

- CACHE の値は 1 または 65536 以上のみ対応。中間値 (例: 100 や 1000) は使用不可
- データ型は BIGINT のみサポート
- シーケンス値のギャップレス (隙間なし) な割り当ては保証されない
- IDENTITY 列は自動的に NOT NULL となるが、一意性は保証されない (PRIMARY KEY や UNIQUE 制約が別途必要)

### 考慮すべき点

- 分散環境では CACHE >= 65536 使用時にセッション間で値の順序が保証されない
- キャッシュされた値が消費されずにセッションが終了すると、シーケンスにギャップが発生する
- スケーラビリティが重要なプライマリキーには、シーケンスよりも UUID の使用が推奨される
- setval による値のリセットは、他のセッションがキャッシュ済みの値を消費するまで反映されない

## ユースケース

### ユースケース 1: 注文管理システムの ID 生成

**シナリオ**: E コマースアプリケーションで、人間が読みやすい注文番号を自動生成したい。

**実装例**:
```sql
CREATE TABLE orders (
    order_id bigint GENERATED ALWAYS AS IDENTITY (CACHE 65536 START 100001),
    product_name text,
    quantity int,
    total_amount numeric
);

INSERT INTO orders (product_name, quantity, total_amount)
VALUES ('ノートパソコン', 1, 150000);
-- order_id: 100001
```

**効果**: アプリケーション側で ID 生成ロジックを実装することなく、100001 から始まる連番の注文番号を自動生成できます。

### ユースケース 2: 既存 PostgreSQL アプリケーションの移行

**シナリオ**: 既存の PostgreSQL データベースで IDENTITY 列を使用しているアプリケーションを Aurora DSQL に移行したい。

**実装例**:
```sql
-- 既存の PostgreSQL スキーマ (移行元)
-- CREATE TABLE users (
--     user_id bigint GENERATED ALWAYS AS IDENTITY,
--     username text
-- );

-- Aurora DSQL 向けに CACHE を追加
CREATE TABLE users (
    user_id bigint GENERATED ALWAYS AS IDENTITY (CACHE 65536),
    username text
);
```

**効果**: CACHE パラメータの追加のみで、既存のスキーマをほぼそのまま Aurora DSQL に移行でき、アプリケーションコードの変更は不要です。

### ユースケース 3: サポートチケットの参照番号

**シナリオ**: カスタマーサポートシステムで、順序性を重視したチケット番号を生成したい。

**実装例**:
```sql
CREATE SEQUENCE ticket_seq CACHE 1 START 1;

CREATE TABLE support_tickets (
    ticket_id bigint DEFAULT nextval('ticket_seq'),
    subject text,
    status text DEFAULT 'open',
    created_at timestamp DEFAULT now()
);

INSERT INTO support_tickets (subject)
VALUES ('ログインできない');
-- ticket_id: 1
```

**効果**: CACHE = 1 を使用することで、チケット番号の順序性を保ちつつ、自動的に連番を割り当てることができます。

## 料金

Aurora DSQL は従量課金制で、ID 列やシーケンスオブジェクトの使用に追加料金は発生しません。

| 項目 | 説明 |
|------|------|
| DPU (Distributed Processing Unit) | リクエストベースのアクティビティに対して課金 |
| ストレージ | データベースサイズ (GB-月) に対して課金 |

AWS Free Tier では、毎月最初の 100,000 DPU と 1 GB-月のストレージが無料です。

## 利用可能リージョン

Aurora DSQL が利用可能なすべてのリージョンで提供されています。

## 関連サービス・機能

- **Amazon Aurora DSQL**: PostgreSQL 互換の分散 SQL データベースサービス
- **Amazon Aurora PostgreSQL**: シーケンスや IDENTITY 列をフルサポートする PostgreSQL 互換エンジン
- **AWS Database Migration Service (DMS)**: 既存の PostgreSQL データベースから Aurora DSQL への移行を支援

## 参考リンク

- 📊 [インフォグラフィック](https://takech9203.github.io/20260213-amazon-aurora-dsql-adds-identity-columns-sequence.html)
- [公式発表 (What's New)](https://aws.amazon.com/about-aws/whats-new/2026/02/amazon-aurora-dsql-identity-columns-sequence-objects/)
- [ドキュメント: Sequences and Identity Columns](https://docs.aws.amazon.com/aurora-dsql/latest/userguide/sequences-identity-columns.html)
- [ドキュメント: CREATE SEQUENCE](https://docs.aws.amazon.com/aurora-dsql/latest/userguide/create-sequence-syntax-support.html)
- [ドキュメント: Identity Columns](https://docs.aws.amazon.com/aurora-dsql/latest/userguide/sequences-identity-columns-overview.html)
- [Aurora DSQL 製品ページ](https://aws.amazon.com/rds/aurora/dsql/)

## まとめ

Amazon Aurora DSQL に IDENTITY 列とシーケンスオブジェクトのサポートが追加され、自動インクリメントの整数ベース ID をデータベースレベルで生成できるようになりました。分散環境に最適化された CACHE 設定 (CACHE = 1 または CACHE >= 65536) により、ワークロードパターンに応じたパフォーマンスと順序性のバランスを選択できます。既存の PostgreSQL アプリケーションからの移行が簡素化され、注文番号やアカウント ID など人間が読みやすい識別子の生成がカスタムロジックなしで実現可能です。
