# Amazon RDS for SQL Server - 差分およびトランザクションログリストアの機能強化

**リリース日**: 2026 年 1 月 21 日
**サービス**: Amazon RDS for SQL Server
**機能**: Multi-AZ およびリードレプリカでの差分およびトランザクションログリストアのサポート

## 概要

Amazon RDS for SQL Server が、Multi-AZ 構成のインスタンスおよび同一リージョン内のリードレプリカを持つインスタンスで、差分およびトランザクションログリストアをサポートするようになりました。ネイティブ SQL Server バックアップおよびリストア機能は、SQL Server データベースの重要なデータを保護し、オンプレミスから Amazon RDS for SQL Server への環境間でのデータベース移行を可能にします。

差分バックアップは、最新のフルバックアップ以降のすべてのデータ変更をキャプチャし、トランザクションログバックアップは、データベース内のすべてのトランザクションを記録します。フルバックアップと組み合わせることで、これらのリストアオプションはデータ損失を最小限に抑える包括的なディザスタリカバリ戦略を作成するのに役立ちます。

**アップデート前の課題**

- ネイティブ SQL Server の差分およびトランザクションログリストアを使用するには、Multi-AZ とリードレプリカを削除して Single-AZ モードに変換する必要がありました
- リストア後に Multi-AZ とリードレプリカを再設定する必要があり、リストア時間が増加しました
- リストア中に高可用性が失われ、ビジネスへの影響がありました

**アップデート後の改善**

- Multi-AZ インスタンスおよびリードレプリカを持つインスタンスで、Single-AZ に変換せずに直接差分およびトランザクションログリストアを実行できるようになりました
- リストア時間が短縮され、Multi-AZ による高可用性を維持できるようになりました
- 同一リージョン内のリードレプリカは、リストア中も読み取りワークロードを提供し続けることができます

## サービスアップデートの詳細

### 主要機能

1. **Multi-AZ インスタンスでのリストア**
   - Multi-AZ 構成のまま、差分およびトランザクションログリストアを実行できます
   - Single-AZ への変換が不要になり、リストア時間が短縮されます
   - リストア中も高可用性が維持されます

2. **リードレプリカでのリストア**
   - 同一リージョン内のリードレプリカを持つインスタンスで、リストアを実行できます
   - リードレプリカは、リストア中も読み取りワークロードを提供し続けることができます
   - リストア後の再設定が不要になります

3. **包括的なディザスタリカバリ戦略**
   - フルバックアップ、差分バックアップ、トランザクションログバックアップを組み合わせて使用できます
   - データ損失を最小限に抑える包括的なディザスタリカバリ戦略を作成できます
   - ポイントインタイムリカバリが可能になります

## 技術仕様

### サポートされるバックアップとリストアの種類

| バックアップの種類 | 説明 | ファイル拡張子 |
|-------------------|------|----------------|
| フルバックアップ | データベース全体のバックアップ | .bak |
| 差分バックアップ | 最新のフルバックアップ以降の変更のみ | .bak |
| トランザクションログバックアップ | すべてのトランザクションを記録 | .trn |

### リストアシーケンスの例

```
1. フルバックアップをリストア (WITH NORECOVERY)
2. 差分バックアップをリストア (WITH NORECOVERY)
3. トランザクションログバックアップをリストア (WITH NORECOVERY)
4. 最後のトランザクションログバックアップをリストア (WITH RECOVERY)
```

### Multi-AZ およびリードレプリカの構成

| 構成 | 差分リストア | トランザクションログリストア |
|------|--------------|------------------------------|
| Single-AZ | サポート | サポート |
| Multi-AZ | サポート (新機能) | サポート (新機能) |
| リードレプリカ (同一リージョン) | サポート (新機能) | サポート (新機能) |
| リードレプリカ (クロスリージョン) | サポート | サポート |

## 設定方法

### 前提条件

1. Amazon RDS for SQL Server インスタンスが作成されていること
2. S3 バケットに SQL Server ネイティブバックアップファイルが保存されていること
3. RDS インスタンスに S3 へのアクセス権限が付与されていること

### 手順

#### ステップ 1: S3 バケットへのバックアップファイルのアップロード

```bash
# フルバックアップを S3 にアップロード
aws s3 cp full_backup.bak s3://my-rds-backups/full_backup.bak

# 差分バックアップを S3 にアップロード
aws s3 cp diff_backup.bak s3://my-rds-backups/diff_backup.bak

# トランザクションログバックアップを S3 にアップロード
aws s3 cp log_backup.trn s3://my-rds-backups/log_backup.trn
```

これらのコマンドは、バックアップファイルを S3 バケットにアップロードします。

#### ステップ 2: フルバックアップのリストア

```sql
-- RDS ストアドプロシージャを使用してフルバックアップをリストア
EXEC msdb.dbo.rds_restore_database
  @restore_db_name='MyDatabase',
  @s3_arn_to_restore_from='arn:aws:s3:::my-rds-backups/full_backup.bak',
  @with_norecovery=1;
```

このクエリは、S3 からフルバックアップをリストアします。`@with_norecovery=1` を指定することで、追加のバックアップをリストアできる状態にします。

#### ステップ 3: 差分バックアップのリストア

```sql
-- 差分バックアップをリストア
EXEC msdb.dbo.rds_restore_database
  @restore_db_name='MyDatabase',
  @s3_arn_to_restore_from='arn:aws:s3:::my-rds-backups/diff_backup.bak',
  @with_norecovery=1,
  @type='DIFFERENTIAL';
```

このクエリは、差分バックアップをリストアします。`@type='DIFFERENTIAL'` を指定することで、差分バックアップとして処理されます。

#### ステップ 4: トランザクションログバックアップのリストア

```sql
-- トランザクションログバックアップをリストア
EXEC msdb.dbo.rds_restore_log
  @restore_db_name='MyDatabase',
  @s3_arn_to_restore_from='arn:aws:s3:::my-rds-backups/log_backup.trn',
  @with_norecovery=1;
```

このクエリは、トランザクションログバックアップをリストアします。

#### ステップ 5: データベースのリカバリ

```sql
-- データベースをリカバリしてオンラインにする
EXEC msdb.dbo.rds_finish_restore
  @db_name='MyDatabase';
```

このクエリは、データベースをリカバリして使用可能な状態にします。

#### ステップ 6: リストアタスクの確認

```sql
-- リストアタスクの進行状況を確認
EXEC msdb.dbo.rds_task_status @db_name='MyDatabase';
```

このクエリは、リストアタスクの進行状況とステータスを表示します。

## メリット

### ビジネス面

- **ダウンタイムの削減**: Multi-AZ への変換が不要になり、リストア時間が短縮されます
- **高可用性の維持**: リストア中も Multi-AZ による高可用性を維持できます
- **ビジネス継続性**: リードレプリカが読み取りワークロードを提供し続けることができます

### 技術面

- **簡素化されたリストアプロセス**: Single-AZ への変換と再設定が不要になります
- **ポイントインタイムリカバリ**: トランザクションログバックアップを使用して、特定の時点にリストアできます
- **データ損失の最小化**: 差分およびトランザクションログバックアップを組み合わせることで、データ損失を最小限に抑えます

## デメリット・制約事項

### 制限事項

- リストア中、データベースはオフラインになります
- 同一リージョン内のリードレプリカのみがサポートされます (クロスリージョンのリードレプリカは以前からサポート)
- S3 バケットへのアクセス権限が必要です

### 考慮すべき点

- リストアシーケンスを正しく実行する必要があります (フル → 差分 → トランザクションログ)
- バックアップファイルのサイズに応じて、リストア時間が異なります
- トランザクションログバックアップは、ログチェーンが切れないように定期的に取得する必要があります

## ユースケース

### ユースケース 1: オンプレミスから RDS への移行

**シナリオ**: オンプレミスの SQL Server データベースを Amazon RDS for SQL Server に移行し、Multi-AZ 構成で高可用性を実現する。

**実装例**:
1. オンプレミスでフルバックアップ、差分バックアップ、トランザクションログバックアップを取得
2. バックアップファイルを S3 にアップロード
3. RDS for SQL Server インスタンス (Multi-AZ 構成) にリストアを実行
4. Single-AZ への変換なしで、直接リストアが完了

**効果**: 移行時間が短縮され、高可用性を維持したまま移行を完了できます。

### ユースケース 2: ポイントインタイムリカバリ

**シナリオ**: データベースの誤操作により、データが失われた。最後の正常な状態にリストアする必要がある。

**実装例**:
1. 最新のフルバックアップをリストア
2. 最新の差分バックアップをリストア
3. 誤操作の直前までのトランザクションログバックアップをリストア
4. データベースをリカバリして、誤操作の直前の状態に戻す

**効果**: データ損失を最小限に抑え、ビジネスへの影響を軽減できます。

### ユースケース 3: ディザスタリカバリ戦略

**シナリオ**: 定期的にバックアップを取得し、ディザスタリカバリ戦略を実装する。

**実装例**:
1. 週次でフルバックアップを取得
2. 日次で差分バックアップを取得
3. 15 分ごとにトランザクションログバックアップを取得
4. 障害発生時、最新のフル、差分、トランザクションログバックアップをリストア

**効果**: データ損失を最小限に抑え、迅速なリカバリを実現できます。

## 料金

この機能自体に追加料金はかかりません。ただし、以下のサービスの使用に対して料金が発生します。

- Amazon RDS for SQL Server のインスタンス料金
- Amazon S3 のストレージ料金
- データ転送料金

詳細については、[Amazon RDS Pricing](https://aws.amazon.com/rds/pricing/) を参照してください。

## 利用可能リージョン

この機能は、Amazon RDS for SQL Server をサポートするすべての AWS リージョンで利用可能です。

## 関連サービス・機能

- **Amazon S3**: バックアップファイルを保存するオブジェクトストレージサービス
- **AWS Backup**: 自動化されたバックアップサービス
- **Amazon RDS Automated Backups**: RDS の自動バックアップ機能

## 参考リンク

- [公式発表 (What's New)](https://aws.amazon.com/about-aws/whats-new/2026/01/amazon-rds-sql-server-diff-and-log-restores-for-maz-and-rr/)
- [Importing and exporting SQL Server databases using native backup and restore ドキュメント](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/SQLServer.Procedural.Importing.html)
- [Amazon RDS for SQL Server User Guide](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/)

## まとめ

Amazon RDS for SQL Server が Multi-AZ およびリードレプリカでの差分およびトランザクションログリストアをサポートしたことで、リストア時間が短縮され、高可用性を維持したままディザスタリカバリを実行できるようになりました。Single-AZ への変換が不要になり、リストアプロセスが簡素化されました。Amazon RDS for SQL Server を使用している組織は、この機能を活用して包括的なディザスタリカバリ戦略を実装することをお勧めします。
